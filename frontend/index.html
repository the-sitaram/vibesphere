<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VibeSphere - Social Media App</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.4.0/axios.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .post-card {
            transition: all 0.3s ease;
        }
        .post-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .heart-animation {
            animation: heartBeat 0.6s ease-in-out;
        }
        @keyframes heartBeat {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
        .navbar-glass {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useContext, createContext } = React;

        // API Configuration
        const API_BASE_URL = 'http://localhost:8000/api';
        const AUTH_BASE_URL = 'http://localhost:8000/auth';

        // Create Auth Context
        const AuthContext = createContext();

        // Auth Provider Component
        const AuthProvider = ({ children }) => {
            const [user, setUser] = useState(null);
            const [token, setToken] = useState(localStorage.getItem('token'));
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if (token) {
                    fetchUser();
                } else {
                    setLoading(false);
                }
            }, [token]);

            const fetchUser = async () => {
                try {
                    const response = await axios.get(`${AUTH_BASE_URL}/users/me/`, {
                        headers: { Authorization: `Token ${token}` }
                    });
                    setUser(response.data);
                } catch (error) {
                    console.error('Error fetching user:', error);
                    logout();
                } finally {
                    setLoading(false);
                }
            };

            const login = async (email, password) => {
                try {
                    const response = await axios.post(`${AUTH_BASE_URL}/token/login/`, {
                        email,
                        password
                    });
                    const newToken = response.data.auth_token;
                    localStorage.setItem('token', newToken);
                    setToken(newToken);
                    return { success: true };
                } catch (error) {
                    return { 
                        success: false, 
                        error: error.response?.data?.non_field_errors?.[0] || 'Login failed' 
                    };
                }
            };

            const register = async (username, email, password) => {
                try {
                    const response = await axios.post(`${AUTH_BASE_URL}/users/`, {
                        username,
                        email,
                        password
                    });
                    return { success: true };
                } catch (error) {
                    return { 
                        success: false, 
                        error: error.response?.data || 'Registration failed' 
                    };
                }
            };

            const logout = () => {
                localStorage.removeItem('token');
                setToken(null);
                setUser(null);
            };

            return (
                <AuthContext.Provider value={{ 
                    user, 
                    token, 
                    login, 
                    register, 
                    logout, 
                    loading 
                }}>
                    {children}
                </AuthContext.Provider>
            );
        };

        // Custom Hook for Auth
        const useAuth = () => {
            const context = useContext(AuthContext);
            if (!context) {
                throw new Error('useAuth must be used within AuthProvider');
            }
            return context;
        };

        // Navbar Component
        const Navbar = () => {
            const { user, logout } = useAuth();

            return (
                <nav className="navbar-glass sticky top-0 z-50 px-4 py-3">
                    <div className="max-w-6xl mx-auto flex justify-between items-center">
                        <div className="flex items-center space-x-4">
                            <h1 className="text-2xl font-bold gradient-bg bg-clip-text text-transparent">
                                VibeSphere
                            </h1>
                        </div>
                        
                        <div className="flex items-center space-x-4">
                            <div className="flex items-center space-x-2">
                                {user?.profile_picture ? (
                                    <img 
                                        src={user.profile_picture} 
                                        alt="Profile" 
                                        className="w-8 h-8 rounded-full object-cover"
                                    />
                                ) : (
                                    <div className="w-8 h-8 bg-purple-500 rounded-full flex items-center justify-center text-white text-sm font-semibold">
                                        {user?.username?.[0]?.toUpperCase()}
                                    </div>
                                )}
                                <span className="text-gray-700 font-medium">@{user?.username}</span>
                            </div>
                            <button 
                                onClick={logout}
                                className="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors"
                            >
                                Logout
                            </button>
                        </div>
                    </div>
                </nav>
            );
        };

        // Login Component
        const LoginForm = ({ onToggle }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);
            const { login } = useAuth();

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');

                const result = await login(email, password);
                if (!result.success) {
                    setError(result.error);
                }
                setLoading(false);
            };

            return (
                <div className="min-h-screen gradient-bg flex items-center justify-center px-4">
                    <div className="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
                        <div className="text-center mb-8">
                            <h1 className="text-3xl font-bold text-gray-900 mb-2">Welcome Back</h1>
                            <p className="text-gray-600">Sign in to your VibeSphere account</p>
                        </div>

                        {error && (
                            <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
                                {error}
                            </div>
                        )}

                        <form onSubmit={handleSubmit} className="space-y-6">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Email
                                </label>
                                <input
                                    type="email"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                    placeholder="Enter your email"
                                    required
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Password
                                </label>
                                <input
                                    type="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                    placeholder="Enter your password"
                                    required
                                />
                            </div>

                            <button
                                type="submit"
                                disabled={loading}
                                className="w-full gradient-bg text-white py-3 rounded-lg font-semibold hover:opacity-90 transition-opacity disabled:opacity-50"
                            >
                                {loading ? 'Signing In...' : 'Sign In'}
                            </button>
                        </form>

                        <div className="mt-6 text-center">
                            <p className="text-gray-600">
                                Don't have an account?{' '}
                                <button 
                                    onClick={onToggle}
                                    className="text-purple-600 hover:text-purple-800 font-semibold"
                                >
                                    Sign Up
                                </button>
                            </p>
                        </div>
                    </div>
                </div>
            );
        };

        // Register Component
        const RegisterForm = ({ onToggle }) => {
            const [username, setUsername] = useState('');
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);
            const [success, setSuccess] = useState(false);
            const { register } = useAuth();

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');

                const result = await register(username, email, password);
                if (result.success) {
                    setSuccess(true);
                    setTimeout(() => onToggle(), 2000);
                } else {
                    setError(typeof result.error === 'object' ? 
                        Object.values(result.error).flat().join(', ') : 
                        result.error
                    );
                }
                setLoading(false);
            };

            if (success) {
                return (
                    <div className="min-h-screen gradient-bg flex items-center justify-center px-4">
                        <div className="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md text-center">
                            <div className="text-green-500 text-6xl mb-4">✓</div>
                            <h2 className="text-2xl font-bold text-gray-900 mb-2">Account Created!</h2>
                            <p className="text-gray-600">Redirecting to login...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen gradient-bg flex items-center justify-center px-4">
                    <div className="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
                        <div className="text-center mb-8">
                            <h1 className="text-3xl font-bold text-gray-900 mb-2">Join VibeSphere</h1>
                            <p className="text-gray-600">Create your account to get started</p>
                        </div>

                        {error && (
                            <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
                                {error}
                            </div>
                        )}

                        <form onSubmit={handleSubmit} className="space-y-6">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Username
                                </label>
                                <input
                                    type="text"
                                    value={username}
                                    onChange={(e) => setUsername(e.target.value)}
                                    className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                    placeholder="Choose a username"
                                    required
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Email
                                </label>
                                <input
                                    type="email"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                    placeholder="Enter your email"
                                    required
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Password
                                </label>
                                <input
                                    type="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                    placeholder="Create a password"
                                    required
                                />
                            </div>

                            <button
                                type="submit"
                                disabled={loading}
                                className="w-full gradient-bg text-white py-3 rounded-lg font-semibold hover:opacity-90 transition-opacity disabled:opacity-50"
                            >
                                {loading ? 'Creating Account...' : 'Sign Up'}
                            </button>
                        </form>

                        <div className="mt-6 text-center">
                            <p className="text-gray-600">
                                Already have an account?{' '}
                                <button 
                                    onClick={onToggle}
                                    className="text-purple-600 hover:text-purple-800 font-semibold"
                                >
                                    Sign In
                                </button>
                            </p>
                        </div>
                    </div>
                </div>
            );
        };

        // Post Card Component
        const PostCard = ({ post, onLike, onComment }) => {
            const [liked, setLiked] = useState(post.is_liked);
            const [likesCount, setLikesCount] = useState(post.likes_count);
            const [showComments, setShowComments] = useState(false);
            const [newComment, setNewComment] = useState('');

            const handleLike = async () => {
                try {
                    if (liked) {
                        await onLike(post.id, 'unlike');
                        setLikesCount(prev => prev - 1);
                    } else {
                        await onLike(post.id, 'like');
                        setLikesCount(prev => prev + 1);
                    }
                    setLiked(!liked);
                } catch (error) {
                    console.error('Error liking post:', error);
                }
            };

            const handleComment = async () => {
                if (newComment.trim()) {
                    try {
                        await onComment(post.id, newComment);
                        setNewComment('');
                    } catch (error) {
                        console.error('Error adding comment:', error);
                    }
                }
            };

            return (
                <div className="post-card bg-white rounded-2xl shadow-lg overflow-hidden mb-6">
                    {/* Post Header */}
                    <div className="flex items-center p-4">
                        {post.author_profile_picture ? (
                            <img 
                                src={post.author_profile_picture} 
                                alt={post.author}
                                className="w-10 h-10 rounded-full object-cover"
                            />
                        ) : (
                            <div className="w-10 h-10 bg-purple-500 rounded-full flex items-center justify-center text-white font-semibold">
                                {post.author[0]?.toUpperCase()}
                            </div>
                        )}
                        <div className="ml-3">
                            <p className="font-semibold text-gray-900">{post.author}</p>
                            <p className="text-sm text-gray-500">
                                {new Date(post.created_at).toLocaleDateString()}
                            </p>
                        </div>
                    </div>

                    {/* Post Image */}
                    <img 
                        src={post.image} 
                        alt="Post" 
                        className="w-full h-96 object-cover"
                    />

                    {/* Post Actions */}
                    <div className="p-4">
                        <div className="flex items-center justify-between mb-3">
                            <div className="flex items-center space-x-4">
                                <button 
                                    onClick={handleLike}
                                    className={`flex items-center space-x-2 ${liked ? 'text-red-500' : 'text-gray-600'} hover:text-red-500 transition-colors`}
                                >
                                    <span className={`text-2xl ${liked ? 'heart-animation' : ''}`}>
                                        {liked ? '❤️' : '🤍'}
                                    </span>
                                    <span className="font-semibold">{likesCount}</span>
                                </button>
                                
                                <button 
                                    onClick={() => setShowComments(!showComments)}
                                    className="flex items-center space-x-2 text-gray-600 hover:text-blue-500 transition-colors"
                                >
                                    <span className="text-2xl">💬</span>
                                    <span className="font-semibold">{post.comments_count}</span>
                                </button>
                            </div>
                        </div>

                        {/* Post Caption */}
                        {post.caption && (
                            <p className="text-gray-800 mb-3">
                                <span className="font-semibold">{post.author}</span> {post.caption}
                            </p>
                        )}

                        {/* Comments Section */}
                        {showComments && (
                            <div className="border-t pt-3 mt-3">
                                {/* Add Comment */}
                                <div className="flex items-center space-x-2 mb-3">
                                    <input
                                        type="text"
                                        value={newComment}
                                        onChange={(e) => setNewComment(e.target.value)}
                                        placeholder="Add a comment..."
                                        className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                        onKeyPress={(e) => e.key === 'Enter' && handleComment()}
                                    />
                                    <button
                                        onClick={handleComment}
                                        className="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-colors"
                                    >
                                        Post
                                    </button>
                                </div>

                                {/* Comments List */}
                                <div className="space-y-2 max-h-60 overflow-y-auto">
                                    {post.comments?.map((comment) => (
                                        <div key={comment.id} className="flex items-start space-x-2">
                                            {comment.user_profile_picture ? (
                                                <img 
                                                    src={comment.user_profile_picture} 
                                                    alt={comment.user}
                                                    className="w-6 h-6 rounded-full object-cover"
                                                />
                                            ) : (
                                                <div className="w-6 h-6 bg-gray-400 rounded-full flex items-center justify-center text-white text-xs">
                                                    {comment.user[0]?.toUpperCase()}
                                                </div>
                                            )}
                                            <div className="flex-1">
                                                <p className="text-sm">
                                                    <span className="font-semibold">{comment.user}</span>{' '}
                                                    {comment.text}
                                                </p>
                                                <p className="text-xs text-gray-500">
                                                    {new Date(comment.created_at).toLocaleDateString()}
                                                </p>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // Post Upload Component
        const PostUpload = ({ onPostCreated }) => {
            const [image, setImage] = useState(null);
            const [caption, setCaption] = useState('');
            const [loading, setLoading] = useState(false);
            const [preview, setPreview] = useState(null);
            const { token } = useAuth();

            const handleImageChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    setImage(file);
                    setPreview(URL.createObjectURL(file));
                }
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!image) return;

                setLoading(true);
                const formData = new FormData();
                formData.append('image', image);
                formData.append('caption', caption);

                try {
                    await axios.post(`${API_BASE_URL}/posts/`, formData, {
                        headers: {
                            Authorization: `Token ${token}`,
                            'Content-Type': 'multipart/form-data'
                        }
                    });
                    
                    setImage(null);
                    setCaption('');
                    setPreview(null);
                    onPostCreated();
                } catch (error) {
                    console.error('Error creating post:', error);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="bg-white rounded-2xl shadow-lg p-6 mb-6">
                    <h3 className="text-lg font-semibold mb-4">Create New Post</h3>
                    
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div>
                            <input
                                type="file"
                                accept="image/*"
                                onChange={handleImageChange}
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                required
                            />
                        </div>

                        {preview && (
                            <div className="relative">
                                <img 
                                    src={preview} 
                                    alt="Preview" 
                                    className="w-full h-64 object-cover rounded-lg"
                                />
                            </div>
                        )}

                        <div>
                            <textarea
                                value={caption}
                                onChange={(e) => setCaption(e.target.value)}
                                placeholder="Write a caption..."
                                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 resize-none"
                                rows="3"
                            />
                        </div>

                        <button
                            type="submit"
                            disabled={loading || !image}
                            className="w-full gradient-bg text-white py-3 rounded-lg font-semibold hover:opacity-90 transition-opacity disabled:opacity-50"
                        >
                            {loading ? 'Posting...' : 'Share Post'}
                        </button>
                    </form>
                </div>
            );
        };

        // Main Feed Component
        const Feed = () => {
            const [posts, setPosts] = useState([]);
            const [loading, setLoading] = useState(true);
            const [showUpload, setShowUpload] = useState(false);
            const { token } = useAuth();

            useEffect(() => {
                fetchPosts();
            }, []);

            const fetchPosts = async () => {
                try {
                    const response = await axios.get(`${API_BASE_URL}/posts/`, {
                        headers: { Authorization: `Token ${token}` }
                    });
                    setPosts(response.data.results || response.data);
                } catch (error) {
                    console.error('Error fetching posts:', error);
                } finally {
                    setLoading(false);
                }
            };

            const handleLike = async (postId, action) => {
                await axios[action === 'like' ? 'post' : 'delete'](
                    `${API_BASE_URL}/posts/${postId}/${action}/`,
                    {},
                    { headers: { Authorization: `Token ${token}` } }
                );
            };

            const handleComment = async (postId, text) => {
                await axios.post(
                    `${API_BASE_URL}/posts/${postId}/comment/`,
                    { text },
                    { headers: { Authorization: `Token ${token}` } }
                );
                fetchPosts(); // Refresh posts to show new comment
            };

            if (loading) {
                return (
                    <div className="max-w-2xl mx-auto px-4 py-8">
                        <div className="flex justify-center items-center h-64">
                            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-500"></div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="max-w-2xl mx-auto px-4 py-8">
                    {/* Upload Toggle Button */}
                    <div className="mb-6">
                        <button
                            onClick={() => setShowUpload(!showUpload)}
                            className="w-full gradient-bg text-white py-3 rounded-lg font-semibold hover:opacity-90 transition-opacity"
                        >
                            {showUpload ? 'Cancel' : '+ Create New Post'}
                        </button>
                    </div>

                    {/* Post Upload Form */}
                    {showUpload && (
                        <PostUpload 
                            onPostCreated={() => {
                                fetchPosts();
                                setShowUpload(false);
                            }} 
                        />
                    )}

                    {/* Posts Feed */}
                    {posts.length === 0 ? (
                        <div className="text-center py-12">
                            <p className="text-gray-500 text-lg">No posts yet. Start following people or create your first post!</p>
                        </div>
                    ) : (
                        posts.map((post) => (
                            <PostCard
                                key={post.id}
                                post={post}
                                onLike={handleLike}
                                onComment={handleComment}
                            />
                        ))
                    )}
                </div>
            );
        };

        // Main App Component
        const App = () => {
            const [isLogin, setIsLogin] = useState(true);
            const { user, loading } = useAuth();

            if (loading) {
                return (
                    <div className="min-h-screen gradient-bg flex items-center justify-center">
                        <div className="animate-spin rounded-full h-16 w-16 border-b-2 border-white"></div>
                    </div>
                );
            }

            if (!user) {
                return isLogin ? (
                    <LoginForm onToggle={() => setIsLogin(false)} />
                ) : (
                    <RegisterForm onToggle={() => setIsLogin(true)} />
                );
            }

            return (
                <div className="min-h-screen bg-gray-50">
                    <Navbar />
                    <Feed />
                </div>
            );
        };

        // Root App with Auth Provider
        const Root = () => (
            <AuthProvider>
                <App />
            </AuthProvider>
        );

        ReactDOM.render(<Root />, document.getElementById('root'));
